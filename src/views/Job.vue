<template>
    <div v-if="job" id="jobPage">

        <v-row>
            <v-col cols="12" md="6">
                <v-card class="pa-10 elevation-2">
                    <v-text-field variant="outlined" label="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ©" v-model="job.jobTitle"></v-text-field>
                    <v-text-field type="date" variant="outlined" label="Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ Ù„Ù„ØªÙ‚Ø¯ÙŠÙ…"
                        v-model="job.expireDate"></v-text-field>
                    <v-text-field type="number" variant="outlined" label="Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„ØªÙ‚Ø¯ÙŠÙ… Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙØ©"
                        v-model="job.maximumApplications"></v-text-field>
                    <v-row>
                        <v-col cols="6">
                            <v-text-field type="number" variant="outlined" label="Ø§Ù„Ø¹Ù…Ø± Ù…Ù†"
                                v-model="job.ageFrom"></v-text-field>
                        </v-col>
                        <v-col cols="6">
                            <v-text-field type="number" variant="outlined" label="Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù‰"
                                v-model="job.ageTo"></v-text-field>
                        </v-col>
                    </v-row>
                    <v-row>
                        <v-col cols="6">
                            <v-text-field type="number" variant="outlined" label="Ø§Ù„Ø±Ø§ØªØ¨ Ù…Ù†"
                                v-model="job.salaryFrom"></v-text-field>
                        </v-col>
                        <v-col cols="6">
                            <v-text-field type="number" variant="outlined" label="Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù‰"
                                v-model="job.salaryTo"></v-text-field>
                        </v-col>
                    </v-row>
                    <v-text-field type="number" variant="outlined" label="Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„"
                        v-model="job.workHours"></v-text-field>
                    <v-text-field type="number" variant="outlined" label="Ø§ÙŠØ§Ù… Ø§Ù„Ø§Ø¬Ø§Ø²Ø©"
                        v-model="job.holidays"></v-text-field>
                    <v-text-field type="number" variant="outlined" label="Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¨Ø±Ø©"
                        v-model="job.skillYears"></v-text-field>
                    <v-radio-group v-model="job.gender" label="Ø§Ù„Ø¬Ù†Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨">
                        <v-radio label="Ø°ÙƒØ±" value="male"></v-radio>
                        <v-radio label="Ø§Ù†Ø«Ù‰" value="female"></v-radio>
                        <v-radio label="ÙƒÙ„Ø§Ù‡Ù…Ø§" value="both"></v-radio>
                    </v-radio-group>
                    <v-radio-group v-model="job.education" label="Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ">
                        <v-radio label="ØºÙŠØ± Ù…Ø·Ù„ÙˆØ¨" value="ØºÙŠØ± Ù…Ø·Ù„ÙˆØ¨"></v-radio>
                        <v-radio label="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" value="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©"></v-radio>
                        <v-radio label="Ù…ØªÙˆØ³Ø·Ø©" value="Ù…ØªÙˆØ³Ø·Ø©"></v-radio>
                        <v-radio label="Ø§Ø¹Ø¯Ø§Ø¯ÙŠØ©" value="Ø§Ø¹Ø¯Ø§Ø¯ÙŠØ©"></v-radio>
                        <v-radio label="Ø¨ÙƒØ§Ù„ÙˆØ±ÙŠÙˆØ³" value="Ø¨ÙƒØ§Ù„ÙˆØ±ÙŠÙˆØ³"></v-radio>
                        <v-radio label="Ù…Ø§Ø¬Ø³ØªÙŠØ±" value="Ù…Ø§Ø¬Ø³ØªÙŠØ±"></v-radio>
                        <v-radio label="Ø¯ÙƒØªÙˆØ±Ø§Ø©" value="Ø¯ÙƒØªÙˆØ±Ø§Ø©"></v-radio>
                    </v-radio-group>
                </v-card>
                <v-card class="mt-5 pa-10">
                    <v-textarea auto-grow variant="outlined" label="Ù†Øµ Ø§Ù„Ù…Ù†Ø´ÙˆØ±" :model-value="postData">
                    </v-textarea>
                </v-card>
            </v-col>
            <v-col cols="12" md="6">
                <v-card class="pa-10 elevation-2">
                    <v-textarea variant="outlined" label="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„" v-model="job.description"></v-textarea>
                    <v-autocomplete @update:menu="$fixMenu($event)" variant="outlined" label="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©" :items="provinces"
                        item-title="provinceName" item-value="idProvince" v-model="job.provinceId"></v-autocomplete>
                    <h4>Ø§Ù„Ø§Ø®ØªØµØ§ØµØ§Øª</h4>
                    <v-chip color="primary" class="mx-1" closable @click:close="deleteSkill(skill.idJobCategories)"
                        v-for="skill in job.categories" :key="skill.idJobCategories">
                        {{ skill.categoryTitle }}

                    </v-chip>
                    <v-chip color="warning" class="mx-1" @click="$fixMenu($event)">
                        <b>Ø§Ø¶Ø§ÙØ©</b>
                        <v-menu activator="parent">
                            <v-list height="400">
                                <v-list-item @click="addCategory(item.idCategory)" v-for="(item, index) in categories"
                                    :key="index" :value="item.idCategory">
                                    <v-list-item-title>{{ item.categoryTitle }}</v-list-item-title>
                                </v-list-item>
                            </v-list>
                        </v-menu>
                    </v-chip>
                </v-card>
                <v-card class="pa-10 mt-5 elevation-2">
                    <v-img class="rounded" width="100%" :src="axios.defaults.baseURL + job.image" alt=""></v-img>
                    <input accept="image/*" @change="uploadFile()" type="file" name="file" id="file" style="display:none">
                    <br>
                    <v-btn @click="pickImage()" block variant="tonal" color="warning">
                        <v-icon icon="mdi-image" start></v-icon>
                        <span>ØªØ¹Ø¯ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù</span>
                    </v-btn>
                </v-card>
                <v-card class="pa-10 mt-5 elevation-2">
                    <h3 class="mb-5">Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙØ© ({{ job.totalApplied }})</h3>
                    <v-list-item class="my-2 elevation-0" :prepend-avatar="axios.defaults.baseURL + application.userImage"
                        :title="application.username" :subtitle="'Ø¨ØªØ§Ø±ÙŠØ® : ' + $formatDate(application.createdAt, true)"
                        v-for="application in applications" :key="application.idJobApplication">
                        <template v-slot:append>
                            <v-chip v-if="application.status == 'pending'" color="warning">{{ application.status }}</v-chip>
                            <v-chip v-if="application.status == 'approved'" color="success">{{ application.status
                            }}</v-chip>
                            <v-chip v-if="application.status == 'declined'" color="error">{{ application.status }}</v-chip>
                        </template>
                    </v-list-item>
                </v-card>
                <v-card class="pa-10 mt-5 elevation-2">
                    <h3 class="mb-5">Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ© ({{ ads.length }})</h3>

                    <v-list-item prepend-icon="mdi-bullhorn-outline" class="my-2 elevation-0" :title="ad.adTypeTitle"
                        v-for="ad in ads" :key="ad.idJobAd">
                        <template v-slot:append>
                            <v-chip v-if="ad.status == 'pending'" color="warning">{{ ad.status }}</v-chip>
                            <v-chip v-if="ad.status == 'active'" color="success">{{ ad.status
                            }}</v-chip>
                            <v-chip v-if="ad.status == 'ended'" color="error">{{ ad.status }}</v-chip>
                        </template>
                        <template v-slot:subtitle>
                            <b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹Ù„Ø§Ù† : {{ $formatDate(ad.createdAt, true) }} </b>
                            <br>
                            <b>ÙŠØ¨Ø¯Ø£ ÙÙŠ : {{ $formatDate(ad.startDate) }} </b>
                            <br>
                            <b>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ : {{ $formatDate(ad.endDate) }} </b>
                        </template>
                    </v-list-item>
                </v-card>
            </v-col>
        </v-row>
    </div>
    <v-footer app class="elevation-2">
        <v-row>
            <v-col>
                <v-btn @click="save()" variant="elevated" color="success">
                    <span>Ø­ÙØ¸</span>
                </v-btn>
            </v-col>
            <v-col align="left">
                <v-btn @click="deleteJob()" variant="tonal" color="error">
                    <span>Ø­Ø°Ù Ø§Ù„ÙˆØ¸ÙŠÙØ©</span>
                </v-btn>
            </v-col>
        </v-row>
    </v-footer>
</template>

<script>
export default {
    data: () => ({
        job: null,
        categories: [],
        provinces: [],
        applications: [],
        ads: [],
        postData: null,
    }),
    created: function () {
        this.fetch();
    },
    methods: {
        async fetch() {
            this.$store.state.loading = true;
            this.job = (await this.axios.get("job/" + this.$route.params.id)).data
            this.applications = (await this.axios.get("jobApplications/" + this.$route.params.id)).data
            this.ads = (await this.axios.get("jobAds/" + this.$route.params.id)).data
            this.categories = (await this.axios.get("categorys")).data
            this.provinces = (await this.axios.get("provinces")).data
            this.job.expireDate = this.$formatDate(this.job.expireDate);
            this.postData = `ğŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ©: ${this.job.jobTitle}\nğŸ• Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ Ù„Ù„ØªÙ‚Ø¯ÙŠÙ…: ${this.job.expireDate}\nğŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ©: ${this.job.provinceName}\nğŸ” Ø§Ù„Ø¬Ù†Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${this.job.gender == 'male' ? 'Ø°ÙƒØ±' : this.job.gender == 'female' ? 'Ø§Ù†Ø«Ø¦' : 'ÙƒÙ„Ø§Ù‡Ù…Ø§'}\nğŸ“² Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: https://al-daleel.app/download\nğŸ”— Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ©: https://share.al-daleel.app/${this.job.idJob} \nğŸ›‘ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø´Ø§Ù‡Ø¯Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ©`
            this.$store.state.loading = false;
        },
        async deleteSkill(id) {
            this.$store.state.loading = true;
            await this.axios.delete("jobCategories/" + id);
            this.$store.state.loading = false;
            this.fetch();
        }
        ,
        async addCategory(id) {
            this.$store.state.loading = true;
            await this.axios.post("addJobCategories", {
                jobId: this.$route.params.id,
                categoryId: id,
            });
            this.$store.state.loading = false;
            this.fetch();
        },
        async save() {
            this.$store.state.loading = true;
            await this.axios.put("job/" + this.$route.params.id, {
                jobTitle: this.job.jobTitle,
                expireDate: this.job.expireDate,
                maximumApplications: this.job.maximumApplications,
                ageFrom: this.job.ageFrom,
                ageTo: this.job.ageTo,
                salaryFrom: this.job.salaryFrom,
                salaryTo: this.job.salaryTo,
                workHours: this.job.workHours,
                holidays: this.job.holidays,
                skillYears: this.job.skillYears,
                gender: this.job.gender,
                education: this.job.education,
                description: this.job.description,
                provinceId: this.job.provinceId,
            });
            this.$store.state.loading = false;
            this.$toast.success("ØªÙ… Ø§Ù„Ø­ÙØ¸")
            this.fetch();
        },
        async pickImage() {
            document.getElementById("file").click()
        },
        async uploadFile() {
            this.$store.state.loading = true;
            var formData = new FormData();
            var imagefile = document.querySelector("#file");
            formData.append("file", imagefile.files[0]);
            await this.axios
                .post("editJobImage/" + this.$route.params.id + "?destination=job", formData);
            this.$store.state.loading = false;
            this.fetch();
            this.$toast.success("ØªÙ… Ø§Ù„Ø­ÙØ¸");
        },
        async deleteJob() {
            let c = confirm("Ù‡Ù„ Ø§Ù†Øª Ù…ØªØ£ÙƒØ¯");
            if (c) {
                await this.axios.delete('job/' + this.$route.params.id);
                this.$toast.success("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ¸ÙŠÙØ©");
                setTimeout(() => {
                    this.$router.push('/jobs');
                }, 200);
            }
        }
    }
}
</script>

<style></style>